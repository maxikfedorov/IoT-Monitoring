# Проект IoT-мониторинга теплицы

## Обзор проекта

Данный проект представляет собой комплексное решение для мониторинга и анализа параметров теплицы с использованием IoT-технологий. Система собирает данные с различных датчиков, анализирует их на предмет аномалий и предоставляет прогнозирование будущих значений с помощью предобученной LSTM-модели.

## Функциональность

- **Мониторинг параметров теплицы**: температура и влажность воздуха, освещенность, уровень CO2, влажность и температура почвы, pH почвы и др.
- **Анализ аномалий**: автоматическое обнаружение и классификация аномалий по степени серьезности
- **Прогнозирование**: предсказание будущих значений параметров на основе собранных данных
- **Уведомления**: отправка уведомлений о критических аномалиях через Telegram-бота
- **API**: REST API для интеграции с другими системами

## Архитектура проекта

Проект состоит из следующих компонентов:

- **Flask-сервер**: основное API для взаимодействия с системой
- **LSTM-модель**: для прогнозирования временных рядов
- **Система мониторинга**: для анализа данных и выявления аномалий
- **Telegram-бот**: для отправки уведомлений

## Структура проекта

```
iot/
│
├── src/                            # Исходный код
│   ├── app.py                      # Основное Flask-приложение
│   ├── model.py                    # Работа с LSTM-моделью прогнозирования
│   ├── monitoring.py               # Обнаружение и анализ аномалий
│   ├── monitoring_service.py       # Сервис мониторинга (управление)
│   ├── bot.py                      # Telegram-бот для уведомлений
│   ├── chats/                      # Хранение данных о чатах бота
│   │   └── chats.json              # Список чатов для уведомлений
│   └── data/                       # Примеры данных
│       └── greenhouse_sensors_data.json  # Исторические данные с датчиков
│
├── model/                          # Модели машинного обучения
│   ├── greenhouse_lstm_model.h5    # Предобученная LSTM-модель
│   ├── greenhouse_scaler.joblib    # Нормализатор данных
│   └── greenhouse_model_info.joblib # Информация о модели
│
├── data_temp/                      # Временные данные
│   ├── current_sequence.json       # Текущая последовательность данных
│   ├── predictions.json            # Результаты прогнозирования
│   └── analysis_results.json       # Результаты анализа аномалий
│
└── CodeDet.py                     # Утилита для реструктуризации проекта
```

## Параметры мониторинга

Система отслеживает следующие параметры теплицы и их нормальные диапазоны:

| Параметр | Описание | Нормальный диапазон |
|----------|----------|---------------------|
| temp_hum_1 | Температура воздуха | 15-32°C |
| temp_hum_2 | Влажность воздуха | 50-80% |
| light_1 | Освещенность | 800-1600 лк |
| co2_1 | Уровень CO2 | 350-700 ppm |
| soil_moisture_1 | Влажность почвы | 60-80% |
| soil_temp_1 | Температура почвы | 18-25°C |
| soil_ph_1 | pH почвы | 6.0-7.0 |
| ec_1 | Электропроводность почвы | 1.0-2.5 мСм/см |
| leaf_wetness_1 | Влажность листьев | 0.3-0.7 |

## Требования

- Python 3.7+
- Установленные зависимости (см. ниже)
- Telegram Bot Token (для уведомлений)

## Установка и запуск

### 1. Клонирование репозитория

```bash
git clone https://github.com/username/iot-greenhouse.git
cd iot-greenhouse
```

### 2. Установка зависимостей

```bash
pip install -r requirements.txt
```

Основные зависимости:
- Flask
- Flask-CORS
- TensorFlow
- NumPy
- joblib
- python-telegram-bot
- python-dotenv
- requests

### 3. Настройка переменных окружения

Создайте файл `.env` в корневой директории проекта со следующим содержимым:

```
TELEGRAM_BOT_TOKEN=ваш_токен_бота
```

### 4. Создание необходимых директорий

```bash
mkdir -p data_temp
```

### 5. Запуск сервера

```bash
cd src
python app.py
```

По умолчанию сервер будет доступен по адресу http://127.0.0.1:5000

## Использование API

### Инициализация последовательности

```
POST /initialize
```

Инициализирует последовательность данных нулевыми значениями.

### Добавление записей

```
POST /add_records
```

Тело запроса:
```json
{
  "records": [
    {
      "temp_hum_1": 22.5,
      "temp_hum_2": 65.3,
      "light_1": 1200.0,
      "co2_1": 450.0,
      "soil_moisture_1": 75.0,
      "soil_temp_1": 21.0,
      "soil_ph_1": 6.5,
      "ec_1": 2.0,
      "leaf_wetness_1": 0.5
    }
  ]
}
```

### Прогнозирование

```
POST /predict
```

Тело запроса:
```json
{
  "n_steps": 10
}
```

### Запуск мониторинга

```
POST /monitoring/start
```

### Остановка мониторинга

```
POST /monitoring/stop
```

### Проверка статуса мониторинга

```
GET /monitoring/status
```

### Получение результатов анализа

```
GET /results
```

### Выполнение анализа по требованию

```
POST /monitoring/analyze_now
```

### Управление ботом

```
POST /bot/start
POST /bot/stop
GET /bot/status
```

## Telegram-бот

Команды бота:
- `/start` - Начать получать уведомления
- `/check` - Получить текущую сводку по аномалиям
- `/stop` - Прекратить получать уведомления

## Анализ аномалий

Система классифицирует аномалии по следующим категориям:
- **normal** - нормальные значения
- **minor** - незначительные отклонения (до 10% от диапазона)
- **moderate** - умеренные отклонения (10-30% от диапазона)
- **critical** - критические отклонения (более 30% от диапазона)